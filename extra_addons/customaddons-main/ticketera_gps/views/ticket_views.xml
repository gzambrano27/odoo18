<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- =============================
             🔹 VISTA LISTA (Odoo 18)
        ============================== -->
        <record id="view_ticket_gps_list" model="ir.ui.view">
            <field name="name">ticket.gps.list</field>
            <field name="model">ticket.gps</field>
            <field name="arch" type="xml">
                <list string="Lista de Tickets"
                      decoration-success="color_state == 'creator'"
                      decoration-info="color_state == 'assigned'"
                      decoration-warning="color_state == 'cc'"
                      decoration-danger="color_state == 'delegado'">
                    <field name="color_state" invisible="1"/>
                    <field name="name"/>
                    <field name="creation_date"/>
                    <field name="asunto"/>
                    <field name="encargado" string="Encargado"/>
                    <field name="state" widget="badge"
                           decoration-info="state == 'sent'"
                           decoration-muted="state == 'draft'"
                           decoration-warning="state == 'progress'"
                           decoration-success="state == 'done'"/>
                </list>
            </field>
        </record>

        <!-- =============================
             🔹 VISTA FORMULARIO (Odoo 18)
        ============================== -->
        <record id="view_ticket_gps_form" model="ir.ui.view">
            <field name="name">ticket.gps.form</field>
            <field name="model">ticket.gps</field>
            <field name="arch" type="xml">
                <form string="Ticket GPS">
                    <header>
                        <field name="state" widget="statusbar"
                               statusbar_visible="draft,sent,progress,done"
                               statusbar_fold="done"/>

                        <!-- Botones de estado -->
                        <button name="action_send" type="object" string="Enviar"
                                states="draft"
                                invisible="not (record.show_send_button.raw_value and record.state.raw_value == 'draft')"/>

                        <button name="action_draft" type="object" string="Volver a Borrador"
                                states="sent"
                                invisible="not (record.show_return_draft_button.raw_value and record.state.raw_value == 'sent')"/>

                        <button name="action_progress" type="object" string="En Proceso"
                                states="sent"
                                invisible="not (record.show_assigned_buttons.raw_value and record.state.raw_value == 'sent')"/>

                        <button name="action_done" type="object" string="Finalizado"
                                states="progress"
                                invisible="not (record.show_assigned_buttons.raw_value and record.state.raw_value == 'progress')"/>

                        <!-- Botones de notificación -->
                        <button name="action_notify_delegado" type="object" string="Notificar Delegado"
                                states="progress,done"
                                invisible="not (record.is_encargado_user.raw_value and record.delegar_personal.raw_value)"/>

                        <button name="action_notify_final_cc" type="object" string="Notificar CC"
                                states="done"/>

                        <button name="action_notify_final_encargado" type="object" string="Notificar Encargado"
                                states="done"/>
                    </header>

                    <sheet>
                        <!-- Campos lógicos -->
                        <field name="show_send_button" invisible="1"/>
                        <field name="show_return_draft_button" invisible="1"/>
                        <field name="show_assigned_buttons" invisible="1"/>
                        <field name="resultado_readonly" invisible="1"/>
                        <field name="is_encargado_user" invisible="1"/>

                        <group>
                            <group>
                                <field name="name" readonly="1"/>
                                <field name="creation_date" readonly="1"/>
                                <field name="asunto" readonly="record.state.raw_value != 'draft'"/>
                            </group>
                            <group>
                                <field name="creator_id" readonly="1"/>
                                <field name="sending_user_id" invisible="1"/>
                            </group>
                        </group>

                        <group>
                            <group>
                                <field name="date_sent" invisible="1"/>
                                <field name="date_progress" invisible="1"/>
                                <field name="date_done" groups="base.group_no_one"/>
                            </group>
                        </group>

                        <!-- Encargado, CC -->
                        <group>
                            <group>
                                <field name="encargado" readonly="record.state.raw_value != 'draft'"/>
                                <field name="department_id" readonly="1"/>
                                <field name="company_id" readonly="1"/>
                            </group>
                            <group>
                                <field name="user_name" readonly="1"/>
                                <field name="email" readonly="1"/>
                                <field name="phone" readonly="1"/>
                                <field name="cc" widget="many2many_tags" readonly="record.state.raw_value != 'draft'"/>
                            </group>
                        </group>

                        <!-- Descripción -->
                        <group>
                            <field name="description" widget="html" readonly="record.state.raw_value != 'draft'"/>
                        </group>

                        <!-- Delegar y resultado -->
                        <group invisible="not (record.state.raw_value in ('progress','done'))">
                            <field name="delegar_personal" readonly="record.state.raw_value == 'done'"/>
                            <field name="delegacion_a"
                                   invisible="not record.delegar_personal.raw_value"
                                   readonly="record.state.raw_value == 'done'"/>
                            <field name="resultado" widget="html" force_save="1"
                                   invisible="record.state.raw_value != 'done'"
                                   readonly="record.resultado_readonly.raw_value"/>
                        </group>
                    </sheet>

                    <div class="oe_chatter">
                        <field name="message_follower_ids"
                               groups="base.group_user"
                               options="{'post_refresh': 'recipients'}"/>
                        <field name="activity_ids"/>
                        <field name="message_ids"/>
                    </div>
                </form>
            </field>
        </record>

        <!-- =============================
             🔹 VISTA DE BÚSQUEDA (Odoo 18)
        ============================== -->
        <record id="view_ticket_gps_search" model="ir.ui.view">
            <field name="name">ticket.gps.search</field>
            <field name="model">ticket.gps</field>
            <field name="arch" type="xml">
                <search string="Buscar Tickets">
                    <field name="name" string="Código"/>
                    <field name="creation_date" string="Fecha de creación"/>
                    <field name="asunto" string="Asunto"/>
                    <field name="encargado" string="Encargado"/>
                    <field name="state" string="Estado"/>

                    <filter name="my_tickets" string="Mis Tickets" domain="[('creator_id', '=', uid)]"/>
                    <filter name="asignados_a_mi" string="Tickets asignados a mí" domain="[('encargado.user_id', '=', uid)]"/>
                    <filter name="delegados_a_mi" string="Tickets delegados a mí" domain="[('delegacion_a.user_id', '=', uid)]"/>
                    <filter name="my_cc_tickets" string="Tickets con copia a mí" domain="[('cc.user_id', '=', uid)]"/>
                </search>
            </field>
        </record>

        <!-- =============================
             🔹 ACCIÓN Y MENÚ
        ============================== -->
        <record id="action_ticket_gps" model="ir.actions.act_window">
            <field name="name">Tickets GPS</field>
            <field name="res_model">ticket.gps</field>
            <field name="view_mode">list,form,search</field>
            <field name="context">{'search_default_my_tickets':1,'search_default_asignados_a_mi':1,'search_default_my_cc_tickets':1,'search_default_delegados_a_mi':1}</field>
        </record>

        <menuitem id="menu_ticket_gps_root"
                  name="Tickets GPS"
                  web_icon="ticketera_gps,static/description/icono.png"/>
        <menuitem id="menu_ticket_gps"
                  parent="menu_ticket_gps_root"
                  name="Tickets"
                  action="action_ticket_gps"/>

    </data>
</odoo>
