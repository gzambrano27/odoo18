<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <data>
        <!-- Vista Lista -->
        <record id="view_quality_control_fallas_list" model="ir.ui.view">
            <field name="name">quality.control.fallas.list</field>
            <field name="model">quality.control.fallas</field>
            <field name="arch" type="xml">
                <list string="Reportes de Fallas" default_order="create_date desc">
                    <field name="name"/>
                    <field name="equipo_id"/>
                    <field name="equipo"/>
                    <field name="fecha_fabricacion"/>
                    <field name="finca"/>
                    <field name="codigo_proyecto" widget="badge" decoration-info="1"/>
                    <field name="reportado_por"/>
                    <field name="fecha_falla"/>
                    <field name="create_uid" widget="many2one_avatar_user" string="Creado por" optional="show"/>
                    <field name="create_date" string="Fecha de creación" optional="show"/>
                    <field name="company_id"/>
                </list>
            </field>
        </record>

        <!-- Vista Formulario -->
        <record id="view_quality_control_fallas_form" model="ir.ui.view">
            <field name="name">quality.control.fallas.form</field>
            <field name="model">quality.control.fallas</field>
            <field name="arch" type="xml">
                <form string="Reporte de Fallas / Garantías">
                    <header>
                        <button name="%(report_quality_control_fallas)d"
                                string="Imprimir Reporte de Fallas"
                                type="action"
                                class="oe_highlight"/>

                        <button name="action_generar_requisicion"
                                type="object"
                                class="oe_stat_button"
                                icon="fa-shopping-cart"
                                string="Generar Requisición"
                                invisible="requisition_id or state != 'aprobado' or tipo_garantia != 'garantia_cliente'"/>
                        <field name="requisition_id" invisible="1"/>

                        <button name="action_set_revision"
                                type="object"
                                string="Enviar a Revisión"
                                invisible="state != 'borrador'"
                                class="btn-primary"
                                groups="quality_control_fallas.group_usuario_quality_control"/>

                        <button name="action_set_proceso"
                                type="object"
                                string="En Proceso"
                                invisible="state != 'revision'"
                                class="btn-primary"
                                groups="quality_control_fallas.group_supervisor_quality_control"/>

                        <button name="action_set_rechazado"
                                type="object"
                                string="Rechazar"
                                invisible="state != 'revision'"
                                class="btn-primary"
                                groups="quality_control_fallas.group_supervisor_quality_control"/>

                        <button name="action_set_aprobado"
                                type="object"
                                string="Aprobar"
                                invisible="state != 'proceso'"
                                class="btn-primary"
                                groups="quality_control_fallas.group_supervisor_quality_control"/>

                        <button name="action_set_finalizado"
                                type="object"
                                string="Finalizar"
                                invisible="state != 'aprobado'"
                                class="btn-primary"
                                groups="quality_control_fallas.group_supervisor_quality_control"/>

                        <button name="action_set_borrador"
                                type="object"
                                string="Regresar a Borrador"
                                invisible="not (state in ['aprobado','rechazado','finalizado'])"
                                class="btn-secondary"
                                groups="quality_control_fallas.group_supervisor_quality_control"/>

                        <field name="state" widget="statusbar"/>
                    </header>

                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <button name="%(purchase_request.purchase_request_form_action)d"
                                    type="action"
                                    class="oe_stat_button"
                                    icon="fa-eye"
                                    string="Ver Requisición"
                                    invisible="not requisition_id"/>
                            <field name="requisition_id" invisible="1"/>
                        </div>

                        <group>
                            <group>
                                <field name="equipo_id"
                                       options="{'no_create_edit': True}"
                                       readonly="state in ['aprobado','rechazado','finalizado']"/>
                                <field name="equipo" readonly="state in ['aprobado','rechazado','finalizado']"/>
                                <field name="marca" readonly="state in ['aprobado','rechazado','finalizado']"/>
                                <field name="modelo" readonly="state in ['aprobado','rechazado','finalizado']"/>
                                <field name="serie" readonly="state in ['aprobado','rechazado','finalizado']"/>
                                <field name="fecha_fabricacion" readonly="state in ['aprobado','rechazado','finalizado']"/>
                            </group>
                            <group>
                                <field name="company_id" invisible="1"/>
                                <field name="cliente_id"
                                       options="{'no_create_edit': True}"
                                       readonly="state in ['aprobado','rechazado','finalizado']"/>
                                <field name="finca" readonly="state in ['aprobado','rechazado','finalizado']"/>
                                <field name="codigo_proyecto"
                                       options="{'no_create_edit': True}"
                                       readonly="state in ['aprobado','rechazado','finalizado']"/>
                                <field name="reportado_por" readonly="state in ['aprobado','rechazado','finalizado']"/>
                                <field name="fecha_falla" readonly="state in ['aprobado','rechazado','finalizado']"/>
                                <field name="tipo_garantia" invisible="state != 'aprobado'"/>
                            </group>
                        </group>

                        <group>
                            <field name="descripcion_falla" widget="text" readonly="state in ['aprobado','rechazado','finalizado']"/>
                            <field name="motivo_rechazo" widget="text" invisible="state != 'rechazado'"/>
                        </group>

                        <notebook>
                            <page string="Fotos">
                                <div class="alert alert-warning" style="font-weight: bold;">
                                    Solo se pueden agregar un máximo de 4 fotos.
                                </div>
                                <field name="foto_ids" readonly="state in ['aprobado','rechazado','finalizado']">
                                    <list editable="bottom">
                                        <field name="imagen" widget="image" options="{'size': [100, 100]}"/>
                                        <field name="descripcion"/>
                                    </list>
                                    <form>
                                        <group>
                                            <field name="imagen" widget="image" options="{'size': [200, 200]}"/>
                                            <field name="descripcion"/>
                                        </group>
                                    </form>
                                </field>
                            </page>
                        </notebook>
                    </sheet>

                    <!-- Chatter actualizado -->
                    <chatter/>
                </form>
            </field>
        </record>
    </data>
</odoo>
