<?xml version="1.0" encoding="UTF-8"?>
<odoo>

    <!-- 📋 Vista Lista -->
    <record id="view_lista_solicitud_list" model="ir.ui.view">
        <field name="name">lista.solicitud.list</field>
        <field name="model">physical_security.lista_solicitud</field>
        <field name="arch" type="xml">
            <list string="Lista de Solicitud">
                <field name="codigo" widget="badge" decoration-info="1"/>
                <field name="fecha_actual"/>
                <field name="fecha_estimada"/>
                <field name="responsable" widget="many2one_avatar_user"/>
                <field name="contratista"/>
                <field name="cuenta_analitica" widget="badge" decoration-info="1"/>
                <field name="create_uid" widget="many2one_avatar_user" string="Creado por" optional="show"/>
                <field name="create_date" string="Fecha de creación" optional="show"/>
                <field name="state" string="Estado" widget="badge"
                       decoration-muted="state == 'draft'"
                       decoration-info="state == 'solicitud_enviada'"
                       decoration-success="state == 'solicitud_revisada'"/>
            </list>
        </field>
    </record>

    <!-- 🧾 Vista Formulario -->
    <record id="view_lista_solicitud_form" model="ir.ui.view">
        <field name="name">lista.solicitud.form</field>
        <field name="model">physical_security.lista_solicitud</field>
        <field name="arch" type="xml">
            <form string="Lista de Solicitud" version="18.0">
                <header>
                    <button name="action_envia_solicitud" type="object" string="Enviar Solicitud"
                            invisible="state != 'draft'"
                            class="btn-primary"
                            groups="physical_security_department.group_physical_security_solicitante"/>

                    <button name="action_revisar_solicitud" type="object" string="Aprobar"
                            invisible="state != 'solicitud_enviada'"
                            class="btn-primary"
                            groups="physical_security_department.group_physical_security_seguridad_fisica"/>

                    <button name="action_reset_draft" type="object" string="Regresar a Borrador"
                            invisible="not (state in ['solicitud_enviada','solicitud_revisada'])"
                            class="btn-secondary"
                            groups="physical_security_department.group_physical_security_solicitante,
                                    physical_security_department.group_physical_security_seguridad_fisica"/>

                    <field name="state" widget="statusbar"
                           statusbar_visible="draft,solicitud_enviada,solicitud_revisada"/>
                </header>

                <sheet>
                    <group>
                        <field name="codigo" readonly="1"/>
                        <field name="fecha_actual" readonly="state in ['solicitud_enviada','solicitud_revisada']"/>
                        <field name="fecha_estimada" readonly="state in ['solicitud_enviada','solicitud_revisada']"/>
                        <field name="responsable" widget="many2one_avatar_user" readonly="state in ['solicitud_enviada','solicitud_revisada']"/>
                        <field name="contratista" readonly="state in ['solicitud_enviada','solicitud_revisada']"/>
                        <field name="cuenta_analitica" readonly="state in ['solicitud_enviada','solicitud_revisada']"/>
                    </group>

                    <notebook>
                        <page string="Personas">
                            <field name="line_ids" readonly="state == 'solicitud_revisada'">
                                <list editable="bottom">
                                    <field name="personal_id"
                                           options="{'no_create': True}"
                                           domain="[('id','not in',parent.personal_ids)]"/>
                                    <field name="cargo"/>
                                    <button name="action_open_enlace_documento"
                                            type="object"
                                            icon="fa-file"/>
                                    <field name="aprobado_seguridad" groups="physical_security_department.group_physical_security_seguridad_fisica"/>
                                    <field name="generar_doping" groups="physical_security_department.group_physical_security_seguridad_fisica"/>
                                    <field name="fecha_doping" groups="physical_security_department.group_physical_security_seguridad_fisica"/>
                                    <button name="action_send_to_blacklist" type="object"
                                            string="Enviar a Lista Negra"
                                            class="btn-danger"
                                            groups="physical_security_department.group_physical_security_seguridad_fisica"/>
                                </list>

                                <form string="Línea de Solicitud" version="18.0">
                                    <group>
                                        <field name="personal_id"
                                               options="{'no_create': True}"
                                               domain="[('id','not in',parent.personal_ids)]"/>
                                        <field name="cargo"/>
                                        <field name="aprobado_seguridad" groups="physical_security_department.group_physical_security_seguridad_fisica"/>
                                        <field name="generar_doping" groups="physical_security_department.group_physical_security_seguridad_fisica"/>
                                        <field name="fecha_doping" groups="physical_security_department.group_physical_security_seguridad_fisica"/>
                                    </group>
                                    <footer>
                                        <button name="action_open_enlace_documento" type="object" icon="fa-file" class="btn-secondary"/>
                                        <button name="action_send_to_blacklist" type="object"
                                                string="Enviar a Lista Negra"
                                                class="btn-danger"
                                                groups="physical_security_department.group_physical_security_seguridad_fisica"/>
                                    </footer>
                                </form>
                            </field>
                            <field name="personal_ids" invisible="1"/>
                        </page>

                        <page string="Gestión de Fiscalías">
                            <iframe src="https://www.gestiondefiscalias.gob.ec/siaf/informacion/web/noticiasdelito/index.php"
                                    width="100%" height="500" frameborder="0"/>
                        </page>
                    </notebook>
                </sheet>

                <chatter/>
            </form>
        </field>
    </record>

    <!-- ⚙️ Acción -->
    <record id="action_lista_solicitud" model="ir.actions.act_window">
        <field name="name">Lista de Solicitud</field>
        <field name="res_model">physical_security.lista_solicitud</field>
        <field name="view_mode">list,form</field>
    </record>

</odoo>
