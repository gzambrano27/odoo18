<odoo>
    <data>
        <record id="bryntum_gantt__view_form" model="ir.ui.view">
            <field name="name">bryntum_gantt_view_form</field>
            <field name="model">project.task</field>
            <field name="arch" type="xml">
                <BryntumGantt />
            </field>
        </record>

        <record id="open_gantt_pro" model="ir.actions.act_window">
            <field name="name">Gantt View Pro</field>
            <field name="res_model">project.task</field>
            <field name="view_mode">BryntumGantt</field>
        </record>

        <!-- Actualizar el menú "Project" (project.menu_main_pm) para adicionar el grupo Jefe -->
        <record id="project.menu_main_pm" model="ir.ui.menu">
            <field name="name">Project</field>
            <field name="sequence">70</field>
            <field name="web_icon">project,static/description/icon.svg</field>
            <!-- Usar el campo groups_id (el cual es un many2many) y actualizar su valor -->
            <field name="groups_id" eval="[(6, 0, [ref('project.group_project_manager'),
                                                        ref('project.group_project_user'),
                                                        ref('bryntum_gantt.group_project_jefe')])]" />
        </record>

        <!-- Actualiza el menú Configuration para adicionar también bryntum_gantt.group_project_jefe -->
        <record id="project.menu_project_config" model="ir.ui.menu">
            <field name="groups_id"
                eval="[(6, 0, [ref('project.group_project_manager'), ref('bryntum_gantt.group_project_jefe')])]" />
        </record>

        <menuitem name="Gantt View Pro" id="menu_bryntum_gantt_pro" parent="project.menu_main_pm" sequence="3"
            action="open_gantt_pro"
            groups="project.group_project_user,project.group_project_manager,bryntum_gantt.group_project_jefe,base.group_user" />

        <record id="project.act_project_project_2_project_task_all" model="ir.actions.act_window">
            <field name="view_mode">kanban,list,form,calendar,pivot,graph,activity,BryntumGantt</field>
        </record>

        <record id="project.action_view_task" model="ir.actions.act_window">
            <field name="view_mode">kanban,list,form,calendar,pivot,graph,BryntumGantt,activity</field>
        </record>

        <record id="project_task_view_form" model="ir.ui.view">
            <field name="name">project_task_view_form</field>
            <field name="model">project.task</field>
            <field name="inherit_id" ref="project.view_task_form2" />
            <field name="arch" type="xml">
                <xpath expr="//notebook/page[last()]" position="after">
                    <page name="bryntum_config" string="Bryntum Gantt Fields">
                        <group col="4">
                            <field name="planned_date_begin" widget="date" />
                            <field name="planned_date_end" widget="date" />
                            <field name="cantidad" />
                            <field name="duration" />
                            <field name="percent_done" />
                            <field name="effort" />
                            <field name="scheduling_mode" />
                            <field name="constraint_type" />
                            <field name="constraint_date" widget="date" />
                            <field name="effort_driven" />
                            <field name="manually_scheduled" />
                        </group>
                    </page>
                </xpath>
                <xpath expr="//notebook/page[@id='timesheets_tab']" position="replace">
                    <page string="Timesheets" id="timesheets_tab" groups="hr_timesheet.group_hr_timesheet_user">
                        <group>
                            <group>
                                <label for="allocated_hours" string="Allocated Hours"
                                    invisible="encode_uom_in_days == True" />
                                <label for="allocated_hours" string="Allocated Days"
                                    invisible="encode_uom_in_days == False" />
                                <div class="o_row">
                                    <field name="allocated_hours" class="o_field_float_time oe_inline ms-2"
                                        widget="timesheet_uom_no_toggle" />
                                    <span invisible="subtask_count == 0">
                                        (incl.
                                        <field name="subtask_allocated_hours" nolabel="1"
                                            groups="project.group_subtask_project" widget="timesheet_uom_no_toggle"
                                            class="oe_inline" /> on
                                        <span class="fw-bold text-dark"> Sub-tasks</span>)
                                    </span>
                                </div>
                            </group>
                            <group>
                                <field name="progress" widget="progressbar" />
                            </group>
                        </group>
                        <field name="timesheet_ids" mode="list,kanban"
                            context="{'default_project_id': project_id, 'default_name':''}">
                            <list editable="bottom" string="Timesheet Activities" default_order="date">
                                <field name="date" />
                                <field name="user_id" invisible="1" />
                                <field name="employee_id" required="1" widget="many2one_avatar_employee"
                                    context="{'active_test': True}" options="{'relation': 'hr.employee.public'}"
                                    groups="!hr.group_hr_user" />
                                <field name="employee_id" required="1" widget="many2one_avatar_employee"
                                    context="{'active_test': True}" options="{'relation': 'hr.employee'}"
                                    groups="hr.group_hr_user" />
                                <field name="name" required="0" />
                                <field name="unit_amount" widget="timesheet_uom"
                                    decoration-danger="unit_amount &gt; 24 or unit_amount &lt; 0" />
                                <field name="project_id" invisible="1" />
                                <field name="task_id" invisible="1" />
                                <field name="company_id" invisible="1" />
                            </list>
                            <kanban class="o_kanban_mobile">
                                <field name="date" />
                                <field name="user_id" />
                                <field name="name" />
                                <field name="unit_amount" decoration-danger="unit_amount &gt; 24" />
                                <field name="project_id" />
                                <field name="task_id" invisible="1" />
                                <templates>
                                    <t t-name="kanban-box">
                                        <div t-attf-class="oe_kanban_card oe_kanban_global_click">
                                            <div class="row">
                                                <div class="col-6">
                                                    <field name="employee_id" widget="many2one_avatar_employee"
                                                        context="{'active_test': True}"
                                                        options="{'relation': 'hr.employee.public'}"
                                                        groups="!hr.group_hr_user" />
                                                    <field name="employee_id" widget="many2one_avatar_employee"
                                                        context="{'active_test': True}"
                                                        options="{'relation': 'hr.employee'}"
                                                        groups="hr.group_hr_user" />
                                                    <strong><span>
                                                            <t t-esc="record.employee_id.value" />
                                                        </span></strong>
                                                </div>
                                                <div class="col-6 float-end text-end">
                                                    <strong>
                                                        <t t-esc="record.date.value" />
                                                    </strong>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-6 text-muted">
                                                    <span>
                                                        <t t-esc="record.name.value" />
                                                    </span>
                                                </div>
                                                <div class="col-6">
                                                    <span class="float-end text-end">
                                                        <field name="unit_amount" widget="float_time" />
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </t>
                                </templates>
                            </kanban>
                            <form string="Timesheet Activities">
                                <sheet>
                                    <group>
                                        <field name="date" />
                                        <field name="user_id" invisible="1" />
                                        <field name="employee_id" required="1" widget="many2one_avatar_employee"
                                            context="{'active_test': True}" options="{'relation': 'hr.employee.public'}"
                                            groups="!hr.group_hr_user" />
                                        <field name="employee_id" required="1" widget="many2one_avatar_employee"
                                            context="{'active_test': True}" options="{'relation': 'hr.employee'}"
                                            groups="hr.group_hr_user" />
                                        <field name="name" required="0" />
                                        <field name="unit_amount" string="Duration" widget="float_time"
                                            decoration-danger="unit_amount &gt; 24" />
                                        <field name="project_id" invisible="1" />
                                        <field name="task_id" invisible="1" />
                                        <field name="company_id" invisible="1" />
                                    </group>
                                </sheet>
                            </form>
                        </field>
                        <group>
                            <group class="oe_subtotal_footer oe_right" name="project_hours">
                                <span class="o_td_label float-start">
                                    <label class="fw-bold" for="effective_hours" string="Hours Spent"
                                        invisible="encode_uom_in_days == True" />
                                    <label class="fw-bold" for="effective_hours" string="Days Spent"
                                        invisible="encode_uom_in_days == False" />
                                </span>
                                <field name="effective_hours" widget="timesheet_uom" nolabel="1" />
                                <!-- remove o_form_subtask_button class from master-->
                                <button name="action_view_subtask_timesheet" type="object"
                                    class="o_form_subtask_button ps-0 border-0 oe_inline oe_link mb-2 o_td_label float-start"
                                    invisible="subtask_effective_hours == 0.0">
                                    <span class="text-nowrap" invisible="encode_uom_in_days == True">Hours Spent on
                                        Sub-tasks:</span>
                                    <span class="text-nowrap" invisible="encode_uom_in_days == False">Days Spent on
                                        Sub-tasks:</span>
                                </button>
                                <field name="subtask_effective_hours" class="mt-2" widget="timesheet_uom"
                                    invisible="subtask_effective_hours == 0.0" nolabel="1" />
                                <span invisible="subtask_effective_hours == 0.0" class="o_td_label float-start">
                                    <label class="fw-bold" for="total_hours_spent" string="Total Hours"
                                        invisible="encode_uom_in_days == True" />
                                    <label class="fw-bold" for="total_hours_spent" string="Total Days"
                                        invisible="encode_uom_in_days == False" />
                                </span>
                                <field name="total_hours_spent" widget="timesheet_uom"
                                    class="oe_subtotal_footer_separator" nolabel="1"
                                    invisible="subtask_effective_hours == 0.0" />
                                <span class="o_td_label float-start" invisible="allocated_hours == 0.0">
                                    <label class="fw-bold" for="remaining_hours" string="Remaining Hours"
                                        invisible="encode_uom_in_days == True" />
                                    <label class="fw-bold" for="remaining_hours" string="Remaining Days"
                                        invisible="encode_uom_in_days == False" />
                                    <label class="fw-bold text-danger" for="remaining_hours" string="Remaining Hours"
                                        invisible="encode_uom_in_days == True" />
                                    <label class="fw-bold text-danger" for="remaining_hours" string="Remaining Days"
                                        invisible="encode_uom_in_days == False" />
                                </span>
                                <field name="remaining_hours" widget="timesheet_uom"
                                    class="oe_subtotal_footer_separator" invisible="allocated_hours == 0.0"
                                    nolabel="1" />
                            </group>
                        </group>
                    </page>
                </xpath>
                <xpath expr="//notebook/page[@name='sub_tasks_page']" position="replace">
                    <page name="sub_tasks_page" string="Subtareas">
                        <field name="child_ids"
                            context="{'search_view_ref' : 'project.view_task_search_form_extended', 'default_user_ids': user_ids, 'default_parent_id': id,
                                    'default_partner_id': partner_id, 'default_milestone_id': allow_milestones and milestone_id }"
                            widget="many2many" domain="['!', ('id', 'parent_of', id)]">
                            <list editable="bottom" decoration-muted="state in ['1_done','1_canceled']"
                                open_form_view="True">
                                <field name="allow_milestones" column_invisible="True" />
                                <field name="display_in_project" column_invisible="True" force_save="1" />
                                <field name="sequence" widget="handle" />
                                <field name="id" optional="hide" options="{'enable_formatting': False}" />
                                <field name="parent_id" column_invisible="True" />
                                <field name="priority" widget="priority" nolabel="1" width="20px" />
                                <field name="state" widget="project_task_state_selection" nolabel="1" width="20px" />
                                <field name="name" widget="name_with_subtask_count" />
                                <field name="subtask_count" column_invisible="True" />
                                <field name="closed_subtask_count" column_invisible="True" />
                                <field name="project_id" string="Project" optional="hide" options="{'no_open': 1}"
                                    widget="project" />
                                <field name="milestone_id" optional="hide" context="{'default_project_id': project_id}"
                                    column_invisible="not parent.allow_milestones" invisible="not allow_milestones" />
                                <field name="partner_id" optional="hide" widget="res_partner_many2one"
                                    invisible="not project_id" />
                                <field name="user_ids" widget="many2many_avatar_user" optional="show" />
                                <field name="company_id" groups="base.group_multi_company" optional="hide" />
                                <field name="company_id" column_invisible="True" />
                                <field name="date_deadline" invisible="state in ['1_done', '1_canceled']"
                                    optional="hide"
                                    decoration-danger="date_deadline and date_deadline &lt; current_date" />
                                <field name="activity_ids" string="Next Activity" widget="list_activity"
                                    optional="hide" />
                                <field name="my_activity_date_deadline" string="My Deadline" widget="remaining_days"
                                    options="{'allow_order': '1'}" optional="hide" />
                                <field name="rating_last_text" string="Rating"
                                    decoration-danger="rating_last_text == 'ko'"
                                    decoration-warning="rating_last_text == 'ok'"
                                    decoration-success="rating_last_text == 'top'" class="fw-bold" widget="badge"
                                    optional="hide" invisible="rating_last_text == 'none'" column_invisible="True"
                                    groups="project.group_project_rating" />
                                <field name="tag_ids" widget="many2many_tags" options="{'color_field': 'color'}"
                                    optional="hide" />
                                <field name="stage_id" optional="hide" context="{'default_project_id': project_id}" />
                            </list>
                        </field>
                    </page>
                </xpath>
                <xpath expr="//field[@name='user_ids']" position="after">
                    <field name="employee_ids" class="o_task_user_field"
                        options="{'no_open': True, 'no_quick_create': True, 'no_create': True}"
                        widget="many2many_avatar_user" />
                </xpath>
                <xpath expr="//field[@name='employee_ids']" position="after">
                    <field name="analityc_account" widget="many2many_tags"
                        options="{'color_field': 'color', 'no_create_edit': True}"
                        context="{'project_id': project_id}" />
                    <field name="department_id" />
                </xpath>
                <xpath expr="//field[@name='user_ids']" position="attributes">
                    <attribute name="invisible">1</attribute>
                    <attribute name="options">{'no_create': True}</attribute>
                </xpath>
                <xpath expr="//page[@name='extra_info']" position="attributes">
                    <attribute name="groups"></attribute>
                </xpath>
                <!-- Quitar creación rápida en cuenta analítica -->
                <!--                <xpath expr="//field[@name='analytic_account_id']" position="attributes">-->
                <!--                    <attribute name="options">{'no_create': True, 'no_create_edit': True}</attribute>-->
                <!--                </xpath>-->
            </field>
        </record>
        <record id="project_task_view_quick_create_form" model="ir.ui.view">
            <field name="name">project_task_view_quick_create_form</field>
            <field name="model">project.task</field>
            <field name="inherit_id" ref="project.quick_create_task_form" />
            <field name="arch" type="xml">
                <xpath expr="//field[@name='user_ids']" position="attributes">
                    <attribute name="invisible">1</attribute>
                    <attribute name="options">{'no_create': True}</attribute>
                </xpath>
                <xpath expr="//field[@name='user_ids']" position="after">
                    <field name="employee_ids" class="o_task_user_field"
                        options="{'no_open': True, 'no_quick_create': True, 'no_create': True}"
                        widget="many2many_avatar_user" />
                </xpath>
                <xpath expr="//field[@name='employee_ids']" position="after">
                    <field name="analityc_account" widget="many2many_tags"
                        options="{'color_field': 'color', 'no_create_edit': True}"
                        context="{'project_id': project_id}" />
                    <field name="department_id" />
                </xpath>
            </field>
        </record>

        <record id="project_task_view_tree" model="ir.ui.view">
            <field name="name">project_task_view_tree</field>
            <field name="model">project.task</field>
            <field name="inherit_id" ref="project.view_task_tree2" />
            <field name="arch" type="xml">
                <xpath expr="//field[@name='user_ids']" position="attributes">
                    <attribute name="invisible">1</attribute>
                    <attribute name="options">{'no_create': True}</attribute>
                </xpath>
                <xpath expr="//field[@name='company_id']" position="before">
                    <field name="employee_ids" optional="show" widget="many2many_avatar_user"
                        options="{'no_open': True, 'no_quick_create': True, 'no_create': True}" />
                    <field name="percent_done" widget="progressbar" />
                    <field name="assigned_ids" widget="many2many_tags" />
                </xpath>
                <xpath expr="//field[@name='employee_ids']" position="after">
                    <field name="analityc_account" widget="many2many_tags"
                        options="{'color_field': 'color', 'no_create_edit': True}"
                        context="{'project_id': project_id}" />
                    <field name="department_id" widget="badge" />
                </xpath>
                <xpath expr="//field[@name='priority']" position="replace">
                    <field name="priority" widget="badge" decoration-danger="priority == '2'"
                        decoration-warning="priority == '1'" decoration-success="priority == '0'" />
                </xpath>
                <xpath expr="//field[@name='project_id']" position="replace">
                    <field name="project_id" widget="badge" decoration-muted="1" />
                </xpath>
            </field>
        </record>
        <record id="project_task_view_search" model="ir.ui.view">
            <field name="name">project_task_view_search</field>
            <field name="model">project.task</field>
            <field name="inherit_id" ref="project.view_task_search_form" />
            <field name="arch" type="xml">
                <xpath expr="//field[@name='user_ids']" position="after">
                    <field name="employee_ids"
                        options="{'no_open': True, 'no_quick_create': True, 'no_create': True}" />
                </xpath>
                <xpath expr="//field[@name='user_ids']" position="attributes">
                    <attribute name="invisible">1</attribute>
                    <attribute name="options">{'no_create': True}</attribute>
                </xpath>
                <xpath expr="//field[@name='employee_ids']" position="after">
                    <field name="analityc_account" />
                    <field name="department_id" />
                </xpath>
            </field>
        </record>
        <record id="project_task_view_kanban" model="ir.ui.view">
            <field name="name">project_task_view_kanban</field>
            <field name="model">project.task</field>
            <field name="inherit_id" ref="project.view_task_kanban" />
            <field name="arch" type="xml">
                <!-- ocultamos user_ids porque ahora trabajas con employee_ids -->
                <xpath expr="//field[@name='user_ids']" position="attributes">
                    <attribute name="invisible">1</attribute>
                    <attribute name="options">{'no_create': True}</attribute>
                </xpath>
                <!-- añadimos employee_ids debajo -->
                <xpath expr="//field[@name='user_ids']" position="after">
                    <field name="employee_ids" widget="many2many_avatar_user"
                           options="{'no_open': True, 'no_quick_create': True, 'no_create': True}"/>
                </xpath>
                <!-- añadimos analytic + department -->
                <xpath expr="//field[@name='tag_ids']" position="after">
                    <field name="analityc_account" widget="many2many_tags"
                           options="{'color_field': 'color', 'no_create_edit': True}"
                           context="{'project_id': project_id}"/>
                    <field name="department_id" widget="badge" decoration-muted="1"/>
                </xpath>
                <kanban default_group_by="stage_id" class="o_kanban_small_column o_kanban_project_tasks"
                    on_create="quick_create" quick_create_view="project.quick_create_task_form" examples="project"
                    js_class="project_task_kanban" sample="1">
                    <field name="color" />
                    <field name="priority" widget="badge" decoration-danger="priority == '1'"
                        decoration-warning="priority == '0'" />
                    <field name="alerta_color" invisible="1" />
                </kanban>
                <!-- 🔴 CORRECCIÓN: enganche después del nombre -->
                <xpath expr="//field[@name='name']" position="after">
                    <t t-if="record.alerta.raw_value">
                        <field name="alerta" widget="badge" string="Alerta" optional="show"
                               decoration-success="alerta_color == 'success'"
                               decoration-danger="alerta_color == 'danger'"
                               decoration-warning="alerta_color == 'warning'"/>
                    </t>
                </xpath>
                <xpath expr="//field[@name='project_id']" position="replace">
                    <field name="project_id" widget="badge" decoration-muted="1" />
                </xpath>
                <!-- reemplazar el footer para añadir employee_ids -->
                <xpath expr="//kanban//footer" position="inside">
                    <t t-if="record.employee_ids.raw_value">
                        <field name="employee_ids" widget="many2many_avatar_user"
                               options="{'no_open': True, 'no_quick_create': True, 'no_create': True}"/>
                    </t>
                </xpath>
            </field>
        </record>

        <record id="project_task_view_pivot" model="ir.ui.view">
            <field name="name">project_task_view_pivot</field>
            <field name="model">project.task</field>
            <field name="inherit_id" ref="project.view_project_task_pivot_inherit" />
            <field name="arch" type="xml">
                <xpath expr="//field[@name='user_ids']" position="attributes">
                    <attribute name="invisible">1</attribute>
                    <attribute name="options">{'no_create': True}</attribute>
                </xpath>
                <xpath expr="//field[@name='user_ids']" position="after">
                    <field name="employee_ids" type="row"
                        options="{'no_open': True, 'no_quick_create': True, 'no_create': True}" />
                </xpath>
            </field>
        </record>

        <record id="view_edit_project_inherit_form" model="ir.ui.view">
            <field name="name">project.project.view.inherit</field>
            <field name="model">project.project</field>
            <field name="inherit_id" ref="project.edit_project" />
            <field name="arch" type="xml">
                <xpath expr="//page[last()]" position="after">
                    <page name="bryntum_fields" string="Bryntum Gantt Fields">
                        <div name="project_start_date">
                            <div>
                                <label for="project_start_date" class="oe_inline" string="Project start:" />
                                <field name="project_start_date" class="oe_inline oe_input_align" />
                            </div>
                        </div>
                        <div class="row mt16 o_settings_container" id="gantt_view_pro_management">
                            <div id="use_collaborative_pad" class="col-12 col-lg-6 o_setting_box">
                                <div class="o_setting_left_pane">
                                    <field name="bryntum_auto_scheduling" />
                                </div>
                                <div class="o_setting_right_pane" name="pad_project_right_pane">
                                    <label for="bryntum_auto_scheduling" />
                                    <div class="text-muted">
                                        Auto schedule tasks
                                    </div>
                                </div>
                            </div>
                            <div id="use_collaborative_pad" class="col-12 col-lg-6 o_setting_box">
                                <div class="o_setting_left_pane">
                                    <field name="bryntum_user_assignment" />
                                </div>
                                <div class="o_setting_right_pane" name="pad_project_right_pane">
                                    <label for="bryntum_user_assignment" />
                                    <div class="text-muted">
                                        Use user table as resource base
                                    </div>
                                </div>
                            </div>
                            <div id="exclude_these_stages">
                                <group>
                                    <field name="bryntum_dont_load_domain" widget="domain"
                                        options="{'model': 'project.task', 'in_dialog': true}" />
                                </group>
                            </div>
                        </div>
                    </page>
                </xpath>
            </field>
        </record>
        <!-- <record id="project_task_view_search_inherit_custom" model="ir.ui.view">
            <field name="name">project.task.search.view.override.my_team_tasks</field>
            <field name="model">project.task</field>
            <field name="inherit_id" ref="hr_timesheet.project_task_view_search"/>
            <field name="arch" type="xml">
                <xpath expr="//search" position="inside">
                    <field name="is_assigned_to_my_team" invisible="1"/>
                </xpath>
                <xpath expr="//filter[@name='my_team_tasks']" position="replace">
                    <filter string="Tareas de mi equipoX" name="my_team_tasks1" domain="[('is_assigned_to_my_team', '=', True)]"/>
                </xpath>
            </field>
        </record> -->
    </data>
</odoo>